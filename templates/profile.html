<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Профиль фотографа – {{ photographer.name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Стили для jQuery UI Datepicker -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <!-- Стили для jQuery UI Timepicker Addon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.css">
  <!-- Подключаем Font Awesome для иконок -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ------------------- Общие стили страницы ------------------- */
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background-color: #f0f2f5;
    }
    .profile-container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    .exit-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      color: #333;
      text-decoration: none;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1000;
      cursor: pointer;
    }
    .exit-btn:hover {
      background: #eee;
      color: #000;
    }
    .profile-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .avatar {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ddd;
    }
    .profile-info {
      text-align: left;
      flex: 1;
    }
    .profile-info h2 {
      margin: 0;
      font-size: 32px;
      color: #333;
    }
    .profile-info p {
      margin: 5px 0;
      color: #666;
      font-size: 18px;
    }
    .profile-description {
      background-color: #f7f7f7;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 25px;
      font-size: 18px;
      color: #444;
    }

    /* ------------------- Портфолио с кнопками-стрелками ------------------- */
    .portfolio {
      margin-bottom: 25px;
    }
    .portfolio h3 {
      margin-bottom: 15px;
      text-align: center;
      font-size: 24px;
      color: #333;
    }
    .portfolio-container {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .arrow {
      background-color: #eee;
      border: none;
      font-size: 24px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      margin: 0 5px;
    }
    .arrow:hover {
      background-color: #ddd;
    }
    .portfolio-images {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding-bottom: 5px;
      scroll-behavior: smooth;
      max-width: 100%;
    }
    .portfolio-images img {
      flex: none;
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
    }

    /* ------------------- Кнопки профиля и заказа ------------------- */
    .edit-btn {
      display: inline-block;
      margin-bottom: 25px;
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      text-decoration: none;
      border-radius: 5px;
      font-size: 18px;
      transition: background-color 0.3s ease;
    }
    .edit-btn:hover {
      background-color: #0056b3;
    }
    .order-btn {
      display: block;
      width: 70%;
      margin: 30px auto;
      padding: 15px 25px;
      background-color: #28a745;
      color: #fff;
      text-align: center;
      text-decoration: none;
      border-radius: 5px;
      font-size: 20px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .order-btn:hover {
      background-color: #218838;
      transform: scale(1.05);
    }
    .order-btn.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    /* ------------------- Блок выбора даты и времени ------------------- */
    .date-time-wrapper {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 25px;
    }
    .date-selector {
      flex: 1;
      max-width: 300px;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
    }
    .date-selector h3 {
      margin: 0 0 10px;
      font-size: 20px;
      color: #333;
    }
    .time-selector {
      width: 500px;
      height: 110px;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
      font-size: 20px;
    }
    .time-selector h3 {
      margin: 0 0 15px;
      color: #333;
    }
    .time-select-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }
    select.time-spinner {
      font-size: 18px;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      border: 1px solid #ccc;
    }

    .terms-order-container {
      margin-top: 25px;
    }
    .terms-container {
      text-align: center;
      margin-bottom: 15px;
    }

    /* ------------------- Модальное окно (КАЛЕНДАРЬ) ------------------- */
    .modal-overlay {
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999; /* календарь */
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 320px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-size: 20px;
      color: #aaa;
    }
    .modal-close:hover {
      color: #000;
    }
    .modal-title {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 20px;
      text-align: center;
    }
    .modal-btn {
      display: inline-block;
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      text-decoration: none;
      border-radius: 5px;
      font-size: 16px;
      transition: background-color 0.3s ease;
      border: none;
      cursor: pointer;
    }
    .modal-btn:hover {
      background-color: #0056b3;
    }
    .modal-open-btn {
      margin-top: 10px;
      background-color: #ffc107;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .modal-open-btn:hover {
      background-color: #e0a800;
    }

    /* ------------------- Модальное окно (ИЗОБРАЖЕНИЯ, на весь экран) ------------------- */
    /* ВАЖНО: другие классы, чтобы не конфликтовать с .modal-content для календаря */
    #image-modal-wrapper {
      position: fixed;
      top: 0; 
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.9);
      display: none; /* скрыт по умолчанию */
      z-index: 99999; /* выше, чем у календаря */
      justify-content: center;
      align-items: center;
    }
    #image-modal-wrapper.open {
      display: flex;
    }
    #image-modal-close {
      position: absolute;
      top: 20px;
      right: 35px;
      font-size: 40px;
      color: #fff;
      cursor: pointer;
      z-index: 1001;
    }
    .image-modal-img {
      max-width: 90vw;
      max-height: 90vh;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
    /* Стрелки */
    .modal-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 60px;
      color: #fff;
      background: none;
      border: none;
      cursor: pointer;
      z-index: 1001;
    }
    .modal-left {
      left: 20px;
    }
    .modal-right {
      right: 20px;
    }

    /* ------------------- Стили занятых дат ------------------- */
    .busy-date a {
      background-color: red !important;
      color: white !important;
    }
    .ui-datepicker .ui-state-disabled {
      opacity: 0.5;
    }
    /* Подсветка сегодняшней даты */
    .today-date a {
      background-color: yellow !important;
      color: black !important;
    }
  </style>

  <!-- Telegram WebApp API (если нужно) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    if (window.Telegram && window.Telegram.WebApp) {
      Telegram.WebApp.expand();
    }
  </script>
</head>
<body>
  <div class="profile-container">
    <!-- Кнопка выхода -->
    <a href="javascript:window.history.back()" class="exit-btn" title="Вернуться назад">
      <i class="fa-solid fa-xmark"></i>
    </a>
    
    <!-- Шапка профиля -->
    <div class="profile-header">
      {% if photographer.avatar %}
        <img class="avatar" src="{{ photographer.avatar }}" alt="{{ photographer.name }}">
      {% else %}
        <img class="avatar" src="default-avatar.png" alt="{{ photographer.name }}">
      {% endif %}
      <div class="profile-info">
        <h2>{{ photographer.name }}</h2>
        <p>Город: {{ photographer.city or 'Не указан' }}</p>
        <p>Рейтинг: {{ photographer.rating }}</p>
      </div>
    </div>
    
    <!-- Кнопка редактирования профиля -->
    <a href="{{ url_for('edit_profile', id=photographer.id) }}" class="edit-btn">Редактировать профиль</a>
    
    <!-- Описание профиля -->
    <div class="profile-description">
      <h3>О себе</h3>
      <p>{{ photographer.description }}</p>
    </div>
    
    <!-- Портфолио с кнопками-стрелками -->
    <div class="portfolio">
      <h3>Портфолио</h3>
      <div class="portfolio-container">
        <button class="arrow" onclick="scrollLeftProfile()">‹</button>
        <div class="portfolio-images" id="portfolio-profile-{{ photographer.id }}">
          {% for image in photographer.portfolio_list %}
            <img src="{{ image }}" alt="Portfolio Image">
          {% endfor %}
        </div>
        <button class="arrow" onclick="scrollRightProfile()">›</button>
      </div>
    </div>
    
    <!-- Блок выбора даты и времени -->
    <div class="date-time-wrapper">
      <!-- Календарь (просмотр) -->
      <div class="date-selector">
        <h3>Выберите дату</h3>
        <div id="datepicker-view"></div>
        <!-- Кнопка открытия модального окна для редактирования календаря -->
        <button id="open-modal" class="modal-open-btn">Редактировать календарь</button>
      </div>
      <!-- Блок выбора времени -->
      <div class="time-selector">
        <h3>Выберите время</h3>
        <div class="time-select-container">
          <select id="hour-spinner" class="time-spinner"></select>
          <select id="minute-spinner" class="time-spinner"></select>
        </div>
      </div>
    </div>
    
    <!-- Блок для чекбокса и кнопки "Оформить заказ" -->
    <div class="terms-order-container">
      <div class="terms-container">
        <input type="checkbox" id="terms-checkbox">
        <label for="terms-checkbox">С правилами ознакомлен</label>
      </div>
      <a href="/order/{{ photographer.id }}" class="order-btn disabled" id="order-btn">Оформить заказ</a>
    </div>
  </div>
  
  <!-- Модальное окно (КАЛЕНДАРЬ) -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal-content">
      <span class="modal-close" id="modal-close">&times;</span>
      <h3 class="modal-title">Редактировать календарь</h3>
      <div id="datepicker-edit"></div>
      <button class="modal-btn" id="save-calendar">Сохранить изменения</button>
    </div>
  </div>
  
  <!-- Модальное окно (ИЗОБРАЖЕНИЯ) - на весь экран -->
  <div id="image-modal-wrapper">
    <span id="image-modal-close">&times;</span>
    <img id="modal-image" class="image-modal-img" src="" alt="Portfolio Image">
    <button id="modal-left" class="modal-arrow modal-left">‹</button>
    <button id="modal-right" class="modal-arrow modal-right">›</button>
  </div>
  
  <!-- Подключаем jQuery, jQuery UI и локализацию Datepicker -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/i18n/datepicker-ru.min.js"></script>

  <script>
    /* ------------------ Календарь просмотра ------------------ */
    $.datepicker.setDefaults($.datepicker.regional["ru"]);

    let unavailableDatesStr = "{{ unavailable_dates }}";
    let unavailableDates = [];
    if (unavailableDatesStr.trim().length > 0) {
      unavailableDates = unavailableDatesStr.split(",").map(s => s.trim());
    }
    $("#datepicker-view").datepicker({
      dateFormat: "dd-mm-yy",
      firstDay: 1,
      beforeShowDay: function(date) {
        let today = new Date();
        today.setHours(0,0,0,0);
        if (date < today) {
          return [false, "ui-state-disabled", "Прошедшая дата"];
        }
        if (date.getTime() === today.getTime()) {
          return [true, "today-date", "Сегодня"];
        }
        let d = $.datepicker.formatDate("dd-mm-yy", date);
        if (unavailableDates.indexOf(d) !== -1) {
          return [true, "busy-date", "Недоступно"];
        }
        let day = date.getDay();
        return (day === 0 || day === 6) ? [false, "unavailable", "Фотограф недоступен"] : [true, "available", "Доступно"];
      }
    });

    /* ------------------ Спиннеры времени ------------------ */
    $(function() {
      for (let h = 0; h < 24; h++) {
        let hh = (h < 10 ? "0" + h : h);
        $("#hour-spinner").append(`<option value="${h}">${hh}</option>`);
      }
      const minuteSteps = [0, 10, 20, 30, 40, 50];
      for (let m of minuteSteps) {
        let mm = (m < 10 ? "0" + m : m);
        $("#minute-spinner").append(`<option value="${m}">${mm}</option>`);
      }
      $("#hour-spinner").val("12");
      $("#minute-spinner").val("0");

      $("#terms-checkbox").change(function(){
        if(this.checked){
          $("#order-btn").removeClass("disabled").css({"pointer-events": "auto", "opacity": "1"});
        } else {
          $("#order-btn").addClass("disabled").css({"pointer-events": "none", "opacity": "0.5"});
        }
      });
    });

    /* ------------------ Модальное окно (КАЛЕНДАРЬ) ------------------ */
    const modalOverlay = $("#modal-overlay");
    const openModalBtn = $("#open-modal");
    const closeModalBtn = $("#modal-close");

    openModalBtn.on("click", () => {
      modalOverlay.css("display", "flex");
    });
    closeModalBtn.on("click", () => {
      modalOverlay.css("display", "none");
    });
    modalOverlay.on("click", (e) => {
      if ($(e.target).is("#modal-overlay")) {
        modalOverlay.css("display", "none");
      }
    });

    /* ------------------ Модальное окно (ИЗОБРАЖЕНИЯ) ------------------ */
    let currentPortfolio = [];
    let currentIndex = 0;
    const imageModalWrapper = $("#image-modal-wrapper");
    const modalImg = $("#modal-image");

    // При клике на миниатюру
    $(".portfolio-images img").on("click", function() {
      const portfolioContainer = $(this).closest(".portfolio-images");
      currentPortfolio = [];
      portfolioContainer.find("img").each(function(){
         currentPortfolio.push($(this).attr("src"));
      });
      currentIndex = portfolioContainer.find("img").index($(this));
      modalImg.attr("src", currentPortfolio[currentIndex]);

      // Показываем полноэкранное модальное окно
      imageModalWrapper.addClass("open");
    });

    // Закрытие окна по кнопке
    $("#image-modal-close").on("click", function() {
      imageModalWrapper.removeClass("open");
    });

    // Закрытие окна при клике по фону (если хотите закрывать и так)
    imageModalWrapper.on("click", function(e) {
      // Проверяем, что клик был по самому wrapper, а не по картинке или стрелкам
      if (e.target.id === "image-modal-wrapper") {
        imageModalWrapper.removeClass("open");
      }
    });

    // Навигация по стрелкам
    $("#modal-left").on("click", function(e) {
      e.stopPropagation();
      if(currentPortfolio.length > 0) {
        currentIndex = (currentIndex - 1 + currentPortfolio.length) % currentPortfolio.length;
        modalImg.attr("src", currentPortfolio[currentIndex]);
      }
    });
    $("#modal-right").on("click", function(e) {
      e.stopPropagation();
      if(currentPortfolio.length > 0) {
        currentIndex = (currentIndex + 1) % currentPortfolio.length;
        modalImg.attr("src", currentPortfolio[currentIndex]);
      }
    });

    /* ------------------ Горизонтальная прокрутка портфолио в профиле ------------------ */
    function scrollLeftProfile() {
      const el = document.getElementById("portfolio-profile-{{ photographer.id }}");
      if (el) {
        el.scrollBy({ left: -80, behavior: 'smooth' });
      }
    }
    function scrollRightProfile() {
      const el = document.getElementById("portfolio-profile-{{ photographer.id }}");
      if (el) {
        el.scrollBy({ left: 80, behavior: 'smooth' });
      }
    }
    window.scrollLeftProfile = scrollLeftProfile;
    window.scrollRightProfile = scrollRightProfile;

    /* ------------------ Календарь редактирования ------------------ */
    let editingDates = [...unavailableDates];
    $("#datepicker-edit").datepicker({
      dateFormat: "dd-mm-yy",
      firstDay: 1,
      minDate: 0,
      beforeShowDay: function(date) {
        let d = $.datepicker.formatDate("dd-mm-yy", date);
        if (editingDates.indexOf(d) !== -1) {
          return [true, "busy-date", "Выбрано"];
        }
        return [true, "", "Доступно"];
      },
      onSelect: function(dateText, inst) {
        let index = editingDates.indexOf(dateText);
        if (index === -1) {
          editingDates.push(dateText);
        } else {
          editingDates.splice(index, 1);
        }
        $(this).datepicker("refresh");
      }
    });

    // Сохранение изменений календаря через AJAX
    $("#save-calendar").on("click", function() {
      $.post("{{ url_for('edit_calendar', photographer_id=photographer.id) }}", {
        unavailable_dates: editingDates.join(", ")
      })
      .done(function(response) {
        unavailableDates = [...editingDates];
        $("#datepicker-view").datepicker("refresh");
        modalOverlay.css("display", "none");
        alert("Календарь обновлён!");
      })
      .fail(function() {
        alert("Ошибка обновления календаря");
      });
    });
  </script>
</body>
</html>
